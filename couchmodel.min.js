function UUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=Math.random()*16|0;return(a=="x"?c:c&3|8).toString(16)}).toUpperCase()}var httprequest;
if(typeof XMLHttpRequest!=="undefined")httprequest=function(a,c,b,d){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(this.readyState===4)if(this.status>=200&&this.status<300||this.status===1223){var f=this.getResponseHeader("Content-Type");f==="application/json"||f==="text/json"?d(null,JSON.parse(this.responseText)):d(null,this.responseText)}else d(this.status+" "+this.statusText+"\n"+this.responseText)};e.open(a,c,true,this.username,this.password);e.setRequestHeader("Accept","application/json");
if(b){e.setRequestHeader("Content-Type","application/json");if(typeof b==="object")b=JSON.stringify(b)}e.send(b)};else if(typeof require==="function"){var http=require("http"),urllib=require("url"),base64=require("./base64");httprequest=function(a,c,b,d){c=urllib.parse(c);var e=http.createClient(c.port,c.hostname),f=[];f.push(["Accept","application/json"]);f.push(["Host",c.hostname]);this&&"username"in this&&"password"in this&&f.push(["Authorization","Basic "+base64.encode(this.username+":"+this.password)]);
if(b!==null){if(typeof b==="object")b=JSON.stringify(b);f.push(["Content-Type","application/json"]);f.push(["Content-Length",b.length])}c=c.pathname+(c.search||"");a=e.request(a.toUpperCase(),c,f);var h="";a.addListener("response",function(g){g.setEncoding("utf8");g.addListener("data",function(i){h+=i});g.addListener("end",function(){if(g.statusCode>=200&&g.statusCode<300){var i=g.headers["content-type"];i==="application/json"||i==="text/json"?d(null,JSON.parse(h)):d(null,h)}else d(g.statusCode+": "+
h)})});b!==null&&a.write(b,"utf8");a.end()}}else throw Error("No XHR and no require? What the?");function CouchModel(){if(!(this instanceof arguments.callee))throw Error("Constructor called as a function.");}
CouchModel.newModel=function(a){function c(b){if(b)for(var d in b)this[d]=b[d]}if(!a||!a.url)throw Error("newModel(db) requires a valid db.");if(a.url.charAt(a.url.length-1)!=="/")a.url+="/";c.prototype=new CouchModel;c.prototype.db=a;c.get=function(b,d){var e=this;httprequest.call(a,"GET",a.url+b,null,function(f,h){f?d(f):d(null,new e(h))})};c.list=function(b,d,e,f){var h=this;b=a.url+"_design/"+b+"/_view/"+d+"?include_docs=true";for(var g in e){d=e[g];if(g=="key"||g=="startkey"||g=="endkey")d=JSON.stringify(d);
b+="&"+encodeURIComponent(g)+"="+encodeURIComponent(d)}httprequest.call(a,"GET",b,null,function(i,j){var k=function(){};k.prototype=[];k.prototype.lastKey=null;var l=new k;if(typeof j.rows==="object"&&j.rows instanceof Array){j.rows.forEach(function(m){l.push(new h(m.doc))});l.lastKey=j.rows.length?j.rows[j.rows.length-1].key:null}f(i,l)})};return c};
CouchModel.CouchDB=function(a){if(!(this instanceof arguments.callee))throw Error("Constructor called as a function.");if(typeof a!=="string"||!a.contains("http"))throw Error("db() requires a URL.");this.url=a};CouchModel.CouchDB.prototype.view=function(a,c,b,d){a=this.url+"_design/"+a+"/_view/"+c;if(b){var e=[];for(c in b)e.push(encodeURIComponent(c)+"="+encodeURIComponent(b[c]));a+="?"+e.join("&")}httprequest("GET",a,null,d)};
CouchModel.prototype.save=function(a){if(!this._id)this._id=UUID();var c=this;httprequest.call(this.db,"PUT",this.db.url+this._id,this,function(b,d){b&&a&&a(b);if(d.rev&&a){c._rev=d.rev;a(null)}else a&&a('Response representation does not include "rev". It is a '+typeof d+": "+d)})};CouchModel.prototype.del=function(a){httprequest.call(this.db,"DELETE",this.db.url+this._id+"?rev="+this._rev,null,a)};CouchModel.prototype.set=function(a,c){this[a]=c;return this};
if(typeof exports==="object")exports.CouchModel=CouchModel;

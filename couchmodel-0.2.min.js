function UUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=Math.random()*16|0;return(a=="x"?c:c&3|8).toString(16)}).toUpperCase()}var httprequest;
if(typeof XMLHttpRequest!=="undefined")httprequest=function(a,c,b,d){var f=new XMLHttpRequest;f.onreadystatechange=function(){if(this.readyState===4)if(this.status>=200&&this.status<300||this.status===1223){var e=this.getResponseHeader("Content-Type");e==="application/json"||e==="text/json"?d(null,JSON.parse(this.responseText)):d(null,this.responseText)}else d(this.status+" "+this.statusText+"\n"+this.responseText)};f.open(a,c,true,this.username,this.password);f.setRequestHeader("Accept","application/json");
b&&f.setRequestHeader("Content-Type","application/json");f.send(b)};else if(typeof require==="function"){var http=require("http"),urllib=require("url"),base64=require("./base64");httprequest=function(a,c,b,d){c=urllib.parse(c);var f=http.createClient(c.port,c.hostname),e=[];e.push(["Accept","application/json"]);e.push(["Host",c.hostname]);this&&"username"in this&&"password"in this&&e.push(["Authorization","Basic "+base64.encode(this.username+":"+this.password)]);if(b!==null){if(typeof b==="object")b=
JSON.stringify(b);e.push(["Content-Type","application/json"]);e.push(["Content-Length",b.length])}c=c.pathname+(c.search||"");a=f.request(a.toUpperCase(),c,e);var h="";a.addListener("response",function(g){g.setEncoding("utf8");g.addListener("data",function(i){h+=i});g.addListener("end",function(){if(g.statusCode>=200&&g.statusCode<300){var i=g.headers["content-type"];i==="application/json"||i==="text/json"?d(null,JSON.parse(h)):d(null,h)}else d(g.statusCode+": "+h)})});b!==null&&a.write(b,"utf8");
a.end()}}else throw Error("No XHR and no require? What the?");function CouchModel(){if(!(this instanceof arguments.callee))throw Error("Constructor called as a function.");}
CouchModel.newModel=function(a){function c(b){if(b)for(var d in b)this[d]=b[d]}if(!a||!a.url)throw Error("newModel(db) requires a valid db.");if(a.url.charAt(a.url.length-1)!=="/")a.url+="/";c.prototype=new CouchModel;c.prototype.db=a;c.get=function(b,d){var f=this;httprequest.call(a,"GET",a.url+b,null,function(e,h){e?d(e):d(null,new f(h))})};c.list=function(b,d,f,e){var h=this;b=a.url+"_design/"+b+"/_view/"+d+"?include_docs=true";for(var g in f)b+="&"+encodeURIComponent(g)+"="+encodeURIComponent(f[g]);
httprequest.call(a,"GET",b,null,function(i,j){var k=[];j.rows.forEach&&j.rows.forEach(function(l){k.push(new h(l.doc))});e(i,k)})};return c};CouchModel.prototype.readyState="READY";CouchModel.prototype.save=function(a){if(!this._id)this._id=UUID();var c=this;httprequest.call(this.db,"PUT",this.db.url+this._id,JSON.stringify(this),function(b,d){b&&a&&a(b);if(d.rev&&a){c._rev=d.rev;a(null)}else a&&a('Response representation does not include "rev". It is a '+typeof d+": "+d)})};
CouchModel.prototype.del=function(a){httprequest.call(this.db,"DELETE",this.db.url+this._id+"?rev="+this._rev,null,a)};if(typeof exports==="object")exports.CouchModel=CouchModel;
